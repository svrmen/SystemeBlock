<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Конфигуратор ГРЩ SystemeBlock</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #2c3e50);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: #a0c8f8;
            max-width: 1000px;
            margin: 0 auto 20px;
        }
        
        .app-container {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }
        
        .control-panel {
            flex: 1;
            min-width: 400px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            height: fit-content;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .visualization {
            flex: 2;
            min-width: 500px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: auto;
        }
        
        .panel-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #64b5f6;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .config-section {
            margin-bottom: 25px;
            padding: 15px;
            background: rgba(0, 30, 60, 0.3);
            border-radius: 10px;
        }
        
        .config-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #4fc3f7;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .config-title i {
            font-size: 1.4rem;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        label {
            font-size: 0.95rem;
            color: #bbdefb;
        }
        
        input, select {
            padding: 12px;
            border-radius: 8px;
            border: none;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #2196f3;
            background: rgba(255, 255, 255, 0.95);
        }
        
        .btn {
            background: linear-gradient(90deg, #2196f3, #21cbf3);
            color: white;
            border: none;
            padding: 14px 25px;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 20px rgba(33, 150, 243, 0.6);
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .btn-secondary {
            background: linear-gradient(90deg, #ff9800, #ff5722);
        }
        
        .btn-danger {
            background: linear-gradient(90deg, #f44336, #d32f2f);
        }
        
        .btn-success {
            background: linear-gradient(90deg, #4caf50, #2e7d32);
        }
        
        .cabinet-container {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            justify-content: flex-start;
            overflow-x: auto;
            padding: 10px 0;
        }
        
        .cabinet-column {
            background: rgba(0, 30, 60, 0.7);
            border-radius: 10px;
            padding: 15px;
            border: 2px solid rgba(33, 150, 243, 0.5);
            min-height: 600px;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            position: relative;
        }
        
        .column-title {
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            color: #ff9800;
            font-weight: bold;
        }
        
        .section {
            flex-grow: 1;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow-y: auto;
        }
        
        .incomer, .sectional, .breaker, .avr {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            font-weight: 500;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.15);
            font-size: 0.9rem;
        }
        
        .incomer:hover, .sectional:hover, .breaker:hover, .avr:hover {
            transform: scale(1.03);
            background: rgba(255, 255, 255, 0.12);
        }
        
        .incomer {
            background: linear-gradient(90deg, #2196f3, #3f51b5);
            height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .sectional {
            background: linear-gradient(90deg, #ff9800, #ff5722);
            height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .avr {
            background: linear-gradient(90deg, #9c27b0, #673ab7);
            height: 112px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .breaker {
            background: linear-gradient(90deg, #4caf50, #2e7d32);
        }
        
        .breaker-horizontal {
            display: block;
            width: 100%;
            margin-bottom: 5px;
        }
        
        .breaker-vertical {
            display: flex;
            justify-content: space-between;
            gap: 5px;
            margin-bottom: 5px;
        }
        
        .breaker-vertical-item {
            flex: 1;
            background: linear-gradient(90deg, #4caf50, #2e7d32);
            border-radius: 5px;
            padding: 8px;
            text-align: center;
            font-size: 0.8rem;
        }
        
        .cable-compartment {
            background: rgba(156, 39, 176, 0.1);
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            border: 1px dashed rgba(255, 255, 255, 0.3);
        }
        
        .bus-compartment {
            background: linear-gradient(90deg, #009688, #00796b);
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }
        
        .specs {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }
        
        .specs h3 {
            margin-bottom: 10px;
            color: #e91e63;
            text-align: center;
        }
        
        .specs-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .spec-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        .spec-value {
            color: #64ffda;
            font-weight: 600;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: #90a4ae;
            font-size: 0.9rem;
        }
        
        .warning {
            background: rgba(255, 152, 0, 0.2);
            border: 1px solid #ff9800;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            display: none;
        }
        
        .breaker-config {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .breaker-config input {
            flex: 1;
        }
        
        .breaker-config select {
            width: 120px;
        }
        
        .column-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .column-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .breaker-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .breaker-item {
            background: rgba(0, 150, 136, 0.2);
            border: 1px solid #009688;
            border-radius: 5px;
            padding: 5px 10px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }
        
        .delete-breaker-btn {
            background: none;
            border: none;
            color: #ff5252;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .layout-option {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
        }
        
        .layout-option input {
            margin-right: 5px;
        }
        
        .layout-option.active {
            background: rgba(33, 150, 243, 0.2);
            border: 1px solid #2196f3;
        }
        
        .module-indicator {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.5);
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.8rem;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: #2c3e50;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }
        
        .modal-btn {
            padding: 12px 25px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .modal-btn.confirm {
            background: linear-gradient(90deg, #4caf50, #2e7d32);
            color: white;
        }
        
        .modal-btn.cancel {
            background: linear-gradient(90deg, #f44336, #d32f2f);
            color: white;
        }
        
        .modal-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .expansion-config {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .expansion-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .expansion-title {
            text-align: center;
            font-size: 0.9rem;
            margin-bottom: 5px;
            color: #bbdefb;
        }
        
        .excel-preview {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .excel-preview h4 {
            margin-bottom: 10px;
            color: #64b5f6;
            text-align: center;
        }
        
        .excel-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        
        .excel-table th {
            background: rgba(33, 150, 243, 0.3);
            padding: 8px;
            text-align: left;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .excel-table td {
            padding: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .breaker-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .breaker-modal-content {
            background: #2c3e50;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .breaker-modal-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #64b5f6;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .breaker-config-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .breaker-config-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .breaker-config-group label {
            font-weight: 500;
            color: #bbdefb;
        }
        
        .breaker-config-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        .breaker-preview {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .breaker-preview h4 {
            margin-bottom: 10px;
            color: #64b5f6;
        }
        
        .breaker-preview-list {
            font-size: 0.9rem;
        }
        
        .breaker-preview-item {
            margin-bottom: 5px;
            padding: 5px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }
        
        @media (max-width: 900px) {
            .app-container {
                flex-direction: column;
            }
            
            .visualization {
                min-width: 100%;
            }
            
            .breaker-config-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .vertical-assembly {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
        }
        
        .vertical-assembly-title {
            text-align: center;
            font-size: 0.8rem;
            margin-bottom: 5px;
            color: #bbdefb;
        }
        
        .vertical-assembly-content {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            gap: 5px;
            margin-top: 5px;
            min-height: 100px;
        }
        
        .vertical-breaker {
            flex: 1;
            min-width: 23%;
            background: linear-gradient(90deg, #4caf50, #2e7d32);
            border-radius: 5px;
            padding: 8px;
            text-align: center;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 40px;
            margin: 2px;
        }
        
        .vertical-assembly-space {
            height: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            margin-top: 5px;
        }
        
        .assembly-module-info {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.5);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
        }
        
        .breaker-info {
            font-size: 0.7rem;
            margin-top: 3px;
        }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-dialog {
            background: #2c3e50;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            position: relative;
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Конфигуратор ГРЩ SystemeBlock</h1>
            <p class="subtitle">Профессиональный инструмент для проектирования электрических щитов низкого напряжения с гибкой компоновкой колонн</p>
        </header>
        
        <div class="app-container">
            <div class="control-panel">
                <h2 class="panel-title">Конфигурация щита</h2>
                
                <div class="config-section">
                    <div class="config-title">
                        <i class="fas fa-sliders-h"></i>
                        <span>Общие параметры</span>
                    </div>
                    
                    <div class="input-group">
                        <label>Обслуживание:</label>
                        <div class="layout-option active">
                            <input type="radio" name="layout" id="wall-layout" checked>
                            <label for="wall-layout">Одностороннее (глубина 600 мм)</label>
                        </div>
                        <div class="layout-option">
                            <input type="radio" name="layout" id="center-layout">
                            <label for="center-layout">Двухстороннее (глубина 1000 мм)</label>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label for="ip-rating">Степень защиты IP:</label>
                        <select id="ip-rating">
                            <option value="IP31">IP31</option>
                            <option value="IP54" selected>IP54</option>
                            <option value="IP65">IP65</option>
                        </select>
                    </div>
                    
                    <button id="refresh-btn" class="btn">
                        <i class="fas fa-sync-alt"></i> Обновить визуализацию
                    </button>
                    
                    <button id="export-excel-btn" class="btn btn-success">
                        <i class="fas fa-file-excel"></i> Экспорт в Excel
                    </button>
                </div>
                
                <div class="config-section">
                    <div class="config-title">
                        <i class="fas fa-columns"></i>
                        <span>Колонны щита</span>
                    </div>
                    
                    <div id="columns-container">
                        <!-- Колонны будут добавляться здесь -->
                    </div>
                    
                    <button id="add-column-btn" class="btn">
                        <i class="fas fa-plus"></i> Добавить колонну
                    </button>
                </div>
                
                <div class="excel-preview">
                    <h4>Предпросмотр спецификации</h4>
                    <table class="excel-table" id="excel-preview-table">
                        <thead>
                            <tr>
                                <th>Позиция</th>
                                <th>Артикул</th>
                                <th>Наименование</th>
                                <th>Кол-во</th>
                                <th>Примечание</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Данные будут добавляться здесь -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="visualization">
                <h2 class="panel-title">Визуализация шкафа</h2>
                <div class="cabinet-container" id="cabinet-visualization">
                    <!-- Визуализация колонн будет здесь -->
                </div>
                
                <div class="specs">
                    <h3>Технические характеристики</h3>
                    <div class="specs-list">
                        <div class="spec-item">Общая ширина: <span class="spec-value" id="total-width">0 мм</span></div>
                        <div class="spec-item">Глубина: <span class="spec-value" id="cabinet-depth">600 мм</span></div>
                        <div class="spec-item">Высота: <span class="spec-value">2200 мм</span></div>
                        <div class="spec-item">Степень защиты: <span class="spec-value" id="ip-value">IP54</span></div>
                        <div class="spec-item">Номинальный ток: <span class="spec-value" id="total-current">0 А</span></div>
                        <div class="spec-item">Ток КЗ: <span class="spec-value">100 кА</span></div>
                        <div class="spec-item">Количество колонн: <span class="spec-value" id="column-count">0</span></div>
                        <div class="spec-item">Секционирование: <span class="spec-value">Форма 4b</span></div>
                        <div class="spec-item">Стандарт: <span class="spec-value">IEC 61439</span></div>
                        <div class="spec-item">Кол-во автоматов: <span class="spec-value" id="breaker-count">0</span></div>
                        <div class="spec-item">Использовано модулей: <span class="spec-value" id="used-modules">0/32</span></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>Конфигуратор основан на каталоге SystemeBlock | Низковольтные комплектные устройства на токи до 6300А</p>
            <p>Все спецификации соответствуют стандартам ГОСТ МЭК 61439-1 и ГОСТ МЭК 61439-2</p>
            <p>Экспорт в Excel позволяет генерировать данные для последующего создания чертежей в AutoCAD</p>
            <p>Разработчик: <strong>СтаниСофт</strong></p>
        </div>
    </div>

    <!-- Модальное окно подтверждения -->
    <div class="modal-overlay" id="confirmation-modal">
        <div class="modal-dialog">
            <button class="close-modal" id="close-confirmation-modal">&times;</button>
            <h3 id="modal-title">Подтвердите действие</h3>
            <p id="modal-message">Превышено максимальное количество модулей (32)! Доступно: 5 модулей. Добавить новую колонну?</p>
            <div class="modal-buttons">
                <button class="modal-btn confirm" id="confirm-add">Добавить колонну</button>
                <button class="modal-btn cancel" id="cancel-add">Отмена</button>
            </div>
        </div>
    </div>

    <!-- Модальное окно конфигурации автомата -->
    <div class="modal-overlay" id="breaker-modal">
        <div class="modal-dialog">
            <button class="close-modal" id="close-breaker-modal">&times;</button>
            <h3 class="breaker-modal-title">Конфигурация автомата</h3>
            
            <div class="breaker-config-grid">
                <div class="breaker-config-group">
                    <label>Тип расцепителя:</label>
                    <select id="breaker-trip-unit">
                        <option value="SystemeLogic2">SystemeLogic 2</option>
                        <option value="SystemeLogic5">SystemeLogic 5</option>
                        <option value="TM-D">TM-D</option>
                    </select>
                </div>
                
                <div class="breaker-config-group">
                    <label>Дополнительный контакт:</label>
                    <select id="breaker-aux-contact">
                        <option value="0">Нет</option>
                        <option value="1">1 контакт</option>
                        <option value="2">2 контакта</option>
                    </select>
                </div>
                
                <div class="breaker-config-group">
                    <label>Номинальный ток (А):</label>
                    <select id="breaker-current">
                        <!-- Динамически заполняется -->
                    </select>
                </div>
                
                <div class="breaker-config-group">
                    <label>Способ установки:</label>
                    <select id="breaker-mounting">
                        <option value="fixed">Стационарный</option>
                        <option value="plug-in">Втычной</option>
                        <option value="withdrawable">Выкатной</option>
                    </select>
                </div>
                
                <div class="breaker-config-group">
                    <label>Мотор привод:</label>
                    <select id="breaker-motor-drive">
                        <option value="false">Нет</option>
                        <option value="true">Да</option>
                    </select>
                </div>
                
                <div class="breaker-config-group">
                    <label>Ориентация установки:</label>
                    <select id="breaker-orientation">
                        <option value="horizontal">Горизонтальная</option>
                        <option value="vertical">Вертикальная</option>
                    </select>
                </div>
                
                <div class="breaker-config-group">
                    <label>Количество:</label>
                    <input type="number" id="breaker-quantity" min="1" value="1">
                </div>
            </div>
            
            <div class="breaker-preview">
                <h4>Спецификация автомата</h4>
                <div class="breaker-preview-list" id="breaker-preview">
                    <div class="breaker-preview-item" id="preview-main">Автомат: -</div>
                    <div class="breaker-preview-item" id="preview-aux">Доп. контакт: -</div>
                    <div class="breaker-preview-item" id="preview-mounting">Способ установки: -</div>
                    <div class="breaker-preview-item" id="preview-motor">Мотор привод: -</div>
                    <div class="breaker-preview-item" id="preview-orientation">Ориентация: -</div>
                </div>
            </div>
            
            <div class="breaker-config-buttons">
                <button class="btn btn-success" id="save-breaker-btn">Сохранить</button>
                <button class="btn btn-danger" id="cancel-breaker-btn">Отмена</button>
            </div>
        </div>
    </div>

    <!-- Шаблон для колонны -->
    <template id="column-template">
        <div class="column-item">
            <div class="column-header">
                <h3>Колонна <span class="column-number">1</span></h3>
                <button class="btn btn-danger delete-column-btn">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <div class="input-group">
                <label>Тип колонны:</label>
                <select class="column-type">
                    <option value="incomer">Вводная</option>
                    <option value="sectional">Секционная</option>
                    <option value="outgoing">Отходящая</option>
                </select>
            </div>
            
            <div class="incomer-config">
                <div class="input-group">
                    <label>Количество автоматов:</label>
                    <select class="incomer-count">
                        <option value="1">1</option>
                        <option value="2">2</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label>Номинал автомата:</label>
                    <select class="breaker-size">
                        <option value="800">800А</option>
                        <option value="1000">1000А</option>
                        <option value="1250">1250А</option>
                        <option value="1600">1600А</option>
                        <option value="2000">2000А</option>
                        <option value="2500">2500А</option>
                        <option value="3200">3200А</option>
                        <option value="4000">4000А</option>
                    </select>
                </div>
            </div>
            
            <div class="sectional-config" style="display: none;">
                <div class="input-group">
                    <label>Номинал автомата:</label>
                    <select class="breaker-size">
                        <option value="800">800А</option>
                        <option value="1000">1000А</option>
                        <option value="1250">1250А</option>
                        <option value="1600">1600А</option>
                        <option value="2000">2000А</option>
                        <option value="2500">2500А</option>
                        <option value="3200">3200А</option>
                        <option value="4000">4000А</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label>
                        <input type="checkbox" class="avr-checkbox"> АВР на SystemePLC (9 модулей)
                    </label>
                </div>
            </div>
            
            <div class="expansion-config">
                <div class="expansion-group">
                    <div class="expansion-title">Блок слева</div>
                    <select class="expansion-left">
                        <option value="none">Нет</option>
                        <option value="200">200 мм</option>
                        <option value="400">400 мм</option>
                    </select>
                </div>
                
                <div class="expansion-group">
                    <div class="expansion-title">Блок справа</div>
                    <select class="expansion-right">
                        <option value="none">Нет</option>
                        <option value="200">200 мм</option>
                        <option value="400">400 мм</option>
                    </select>
                </div>
            </div>
            
            <div class="outgoing-config" style="display: none;">
                <div class="input-group">
                    <label>Тип автоматов:</label>
                    <div class="breaker-config">
                        <select class="breaker-type">
                            <option value="100A-250A">100А-250А (3 модуля)</option>
                            <option value="400A-630A">400А-630А (4 модуля)</option>
                        </select>
                    </div>
                </div>
                
                <div class="breaker-container">
                    <!-- Автоматы будут добавляться здесь -->
                </div>
                
                <button class="btn btn-secondary add-breaker-btn">
                    <i class="fas fa-plus"></i> Добавить автомат
                </button>
            </div>
        </div>
    </template>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Ссылки на элементы DOM
            const columnsContainer = document.getElementById('columns-container');
            const cabinetVisualization = document.getElementById('cabinet-visualization');
            const addColumnBtn = document.getElementById('add-column-btn');
            const columnTemplate = document.getElementById('column-template');
            const confirmationModal = document.getElementById('confirmation-modal');
            const modalMessage = document.getElementById('modal-message');
            const confirmAddBtn = document.getElementById('confirm-add');
            const cancelAddBtn = document.getElementById('cancel-add');
            const closeConfirmationModal = document.getElementById('close-confirmation-modal');
            const refreshBtn = document.getElementById('refresh-btn');
            const ipRatingSelect = document.getElementById('ip-rating');
            const exportExcelBtn = document.getElementById('export-excel-btn');
            const excelPreviewTable = document.getElementById('excel-preview-table').querySelector('tbody');
            
            const breakerModal = document.getElementById('breaker-modal');
            const saveBreakerBtn = document.getElementById('save-breaker-btn');
            const cancelBreakerBtn = document.getElementById('cancel-breaker-btn');
            const closeBreakerModal = document.getElementById('close-breaker-modal');
            const breakerTripUnit = document.getElementById('breaker-trip-unit');
            const breakerCurrent = document.getElementById('breaker-current');
            const breakerAuxContact = document.getElementById('breaker-aux-contact');
            const breakerMounting = document.getElementById('breaker-mounting');
            const breakerMotorDrive = document.getElementById('breaker-motor-drive');
            const breakerOrientation = document.getElementById('breaker-orientation');
            const breakerQuantity = document.getElementById('breaker-quantity');
            
            // Переменные состояния
            let columnCounter = 1;
            let groupCounter = 1;
            let currentModalData = {};
            let currentBreakerType = '';
            let currentBreakerColumn = null;
            let currentBreakerItem = null;
            
            // Инициализация приложения
            initApp();
            
            function initApp() {
                // Обработчики событий
                setupEventListeners();
                
                // Инициализация значений
                document.getElementById('ip-value').textContent = ipRatingSelect.value;
                
                // Добавляем первую колонну по умолчанию
                addColumnBtn.click();
            }
            
            function setupEventListeners() {
                // Обновление визуализации
                refreshBtn.addEventListener('click', updateVisualization);
                
                // Обновление степени защиты IP
                ipRatingSelect.addEventListener('change', function() {
                    document.getElementById('ip-value').textContent = this.value;
                });
                
                // Общие настройки
                const layoutOptions = document.querySelectorAll('.layout-option');
                layoutOptions.forEach(option => {
                    option.addEventListener('click', function() {
                        layoutOptions.forEach(opt => opt.classList.remove('active'));
                        this.classList.add('active');
                        const depth = this.querySelector('input').id === 'wall-layout' ? '600 мм' : '1000 мм';
                        document.getElementById('cabinet-depth').textContent = depth;
                        updateVisualization();
                    });
                });
                
                // Закрытие модальных окон
                closeConfirmationModal.addEventListener('click', () => confirmationModal.style.display = 'none');
                closeBreakerModal.addEventListener('click', () => breakerModal.style.display = 'none');
                cancelAddBtn.addEventListener('click', () => confirmationModal.style.display = 'none');
                cancelBreakerBtn.addEventListener('click', () => breakerModal.style.display = 'none');
                
                // Конфигурация автомата
                breakerTripUnit.addEventListener('change', updateBreakerCurrentOptions);
                breakerAuxContact.addEventListener('change', updateBreakerPreview);
                breakerCurrent.addEventListener('change', updateBreakerPreview);
                breakerMounting.addEventListener('change', updateBreakerPreview);
                breakerMotorDrive.addEventListener('change', updateBreakerPreview);
                breakerOrientation.addEventListener('change', updateBreakerPreview);
                
                // Добавление колонны
                addColumnBtn.addEventListener('click', addNewColumn);
                
                // Обработчик подтверждения добавления колонны
                confirmAddBtn.addEventListener('click', handleConfirmAdd);
                
                // Обработчики для модального окна автомата
                saveBreakerBtn.addEventListener('click', handleSaveBreaker);
                
                // Экспорт в Excel
                exportExcelBtn.addEventListener('click', exportToExcel);
            }
            
            function addNewColumn() {
                const columnClone = document.importNode(columnTemplate.content, true);
                const columnNumber = columnCounter++;
                columnClone.querySelector('.column-number').textContent = columnNumber;
                
                // Обработчики событий для колонны
                const deleteBtn = columnClone.querySelector('.delete-column-btn');
                const columnTypeSelect = columnClone.querySelector('.column-type');
                const addBreakerBtn = columnClone.querySelector('.add-breaker-btn');
                const avrCheckbox = columnClone.querySelector('.avr-checkbox');
                const incomerCountSelect = columnClone.querySelector('.incomer-count');
                const sectionalBreakerSize = columnClone.querySelector('.sectional-config .breaker-size');
                const incomerBreakerSize = columnClone.querySelector('.incomer-config .breaker-size');
                const expansionSelects = columnClone.querySelectorAll('.expansion-left, .expansion-right');
                
                // Установка обработчиков
                deleteBtn.addEventListener('click', deleteColumn);
                columnTypeSelect.addEventListener('change', handleColumnTypeChange);
                addBreakerBtn?.addEventListener('click', handleAddBreaker);
                avrCheckbox?.addEventListener('change', updateVisualization);
                incomerCountSelect?.addEventListener('change', updateVisualization);
                sectionalBreakerSize?.addEventListener('change', updateVisualization);
                incomerBreakerSize?.addEventListener('change', updateVisualization);
                
                expansionSelects.forEach(select => {
                    select.addEventListener('change', handleExpansionChange);
                });
                
                // Добавление колонны в контейнер
                columnsContainer.appendChild(columnClone);
                updateVisualization();
                updateExcelPreview();
            }
            
            function deleteColumn() {
                this.closest('.column-item').remove();
                renumberColumns();
                updateVisualization();
                updateExcelPreview();
            }
            
            function handleColumnTypeChange() {
                const columnItem = this.closest('.column-item');
                const incomerConfig = columnItem.querySelector('.incomer-config');
                const sectionalConfig = columnItem.querySelector('.sectional-config');
                const outgoingConfig = columnItem.querySelector('.outgoing-config');
                const expansionConfig = columnItem.querySelector('.expansion-config');
                
                incomerConfig.style.display = 'none';
                sectionalConfig.style.display = 'none';
                outgoingConfig.style.display = 'none';
                
                // Сброс блоков расширения
                const expansionLeft = columnItem.querySelector('.expansion-left');
                const expansionRight = columnItem.querySelector('.expansion-right');
                expansionLeft.value = 'none';
                expansionRight.value = 'none';
                
                if (this.value === 'incomer') {
                    incomerConfig.style.display = 'block';
                    expansionConfig.style.display = 'grid';
                } else if (this.value === 'sectional') {
                    sectionalConfig.style.display = 'block';
                    expansionConfig.style.display = 'grid';
                } else if (this.value === 'outgoing') {
                    outgoingConfig.style.display = 'block';
                    expansionConfig.style.display = 'none';
                    // Назначение группы для отходящих колонн
                    if (!columnItem.dataset.outgoingGroup) {
                        columnItem.dataset.outgoingGroup = groupCounter++;
                    }
                }
                
                updateVisualization();
                updateExcelPreview();
            }
            
            function handleExpansionChange() {
                const columnItem = this.closest('.column-item');
                const leftSelect = columnItem.querySelector('.expansion-left');
                const rightSelect = columnItem.querySelector('.expansion-right');
                
                // Проверка ограничений для 400мм блоков
                if (leftSelect.value === '400' && rightSelect.value === '400') {
                    if (this === leftSelect) {
                        rightSelect.value = 'none';
                    } else {
                        leftSelect.value = 'none';
                    }
                }
                
                updateVisualization();
                updateExcelPreview();
            }
            
            function handleAddBreaker() {
                const columnItem = this.closest('.column-item');
                const breakerType = columnItem.querySelector('.breaker-type').value;
                
                // Сохраняем данные для конфигурации
                currentBreakerType = breakerType;
                currentBreakerColumn = columnItem;
                currentBreakerItem = null;
                
                // Открываем модальное окно конфигурации автомата
                showBreakerModal(1, breakerType);
            }
            
            function handleConfirmAdd() {
                confirmationModal.style.display = 'none';
                const { groupId, breakerConfig, breakerCount } = currentModalData;
                addBreakersWithDistribution(groupId, breakerConfig, breakerCount);
                updateExcelPreview();
            }
            
            function showBreakerModal(count, breakerType, config) {
                // Установить количество
                breakerQuantity.value = count;
                currentBreakerType = breakerType;
                
                // Установить значения по умолчанию или из конфига
                if (config) {
                    breakerTripUnit.value = config.tripUnit;
                    breakerAuxContact.value = config.auxContact;
                    breakerMounting.value = config.mounting;
                    breakerMotorDrive.value = config.motorDrive;
                    breakerOrientation.value = config.orientation || 'horizontal';
                } else {
                    breakerTripUnit.value = 'SystemeLogic2';
                    breakerAuxContact.value = '0';
                    breakerMounting.value = 'fixed';
                    breakerMotorDrive.value = 'false';
                    breakerOrientation.value = 'horizontal';
                }
                
                // Обновить доступные токи
                updateBreakerCurrentOptions();
                
                // Показать модальное окно
                breakerModal.style.display = 'flex';
            }
            
            function updateBreakerCurrentOptions() {
                const tripUnit = breakerTripUnit.value;
                breakerCurrent.innerHTML = '';

                let currents = [];
                
                // Для автоматов 100A-250A
                if (currentBreakerType === '100A-250A') {
                    if (tripUnit === 'TM-D') {
                        currents = [100, 125, 160, 200, 250];
                    } else if (tripUnit === 'SystemeLogic2' || tripUnit === 'SystemeLogic5') {
                        currents = [100, 160, 250];
                    }
                } 
                // Для автоматов 400A-630A
                else if (currentBreakerType === '400A-630A') {
                    if (tripUnit === 'TM-D') {
                        currents = [400, 500, 630];
                    } else if (tripUnit === 'SystemeLogic2' || tripUnit === 'SystemeLogic5') {
                        currents = [400, 630];
                    }
                }

                currents.forEach(current => {
                    const option = document.createElement('option');
                    option.value = current;
                    option.textContent = current + 'А';
                    
                    // Установить выбранное значение из конфига
                    if (currentBreakerItem && currentBreakerItem.dataset.current == current) {
                        option.selected = true;
                    }
                    
                    breakerCurrent.appendChild(option);
                });
                
                // Если для текущего типа расцепителя нет доступных токов
                if (currents.length === 0) {
                    const option = document.createElement('option');
                    option.textContent = 'Нет доступных токов для выбранного типа';
                    breakerCurrent.appendChild(option);
                }
                
                updateBreakerPreview();
            }
            
            function updateBreakerPreview() {
                const tripUnit = breakerTripUnit.value;
                const auxContact = breakerAuxContact.value;
                const current = breakerCurrent.value;
                const mounting = breakerMounting.value;
                const motorDrive = breakerMotorDrive.value === 'true';
                const orientation = breakerOrientation.value;
                const quantity = breakerQuantity.value;
                
                // Определение артикула основного автомата
                let breakerRef = '';
                let breakerDesc = '';
                
                if (tripUnit === 'TM-D') {
                    breakerRef = `SPC${getSizeByCurrent(current)}F${current.toString().padStart(3, '0')}L3DF`;
                    breakerDesc = `Автомат SPC${getSizeByCurrent(current)} TM-D ${current}А`;
                } else if (tripUnit === 'SystemeLogic2') {
                    breakerRef = `SPC${getSizeByCurrent(current)}F${current.toString().padStart(3, '0')}22L3DF`;
                    breakerDesc = `Автомат SPC${getSizeByCurrent(current)} SystemeLogic 2 ${current}А`;
                } else if (tripUnit === 'SystemeLogic5') {
                    breakerRef = `SPC${getSizeByCurrent(current)}F${current.toString().padStart(3, '0')}52E3DFC`;
                    breakerDesc = `Автомат SPC${getSizeByCurrent(current)} SystemeLogic 5 ${current}А`;
                }
                
                document.getElementById('preview-main').textContent = `${breakerDesc} (${breakerRef})`;
                
                // Дополнительный контакт
                if (auxContact !== '0') {
                    document.getElementById('preview-aux').textContent = `Доп. контакт: SPC-OFSD-01-06 (${auxContact} шт)`;
                } else {
                    document.getElementById('preview-aux').textContent = 'Доп. контакт: нет';
                }
                
                // Способ установки
                let mountingRef = '';
                if (mounting === 'plug-in') {
                    mountingRef = parseInt(current) <= 250 ? 'SPC-PIK3-01-02' : 'SPC-PIK3-04-06';
                    document.getElementById('preview-mounting').textContent = `Способ установки: Втычной (${mountingRef})`;
                } else if (mounting === 'withdrawable') {
                    mountingRef = parseInt(current) <= 250 ? 'SPC-DOK3-01-02' : 'SPC-DOK3-04-06';
                    document.getElementById('preview-mounting').textContent = `Способ установки: Выкатной (${mountingRef})`;
                } else {
                    document.getElementById('preview-mounting').textContent = 'Способ установки: Стационарный';
                }
                
                // Мотор привод
                if (motorDrive) {
                    const motorRef = parseInt(current) <= 250 ? 'SPC-MA2-01-02' : 'SPC-MA2-04-06';
                    document.getElementById('preview-motor').textContent = `Мотор привод: ${motorRef}`;
                } else {
                    document.getElementById('preview-motor').textContent = 'Мотор привод: нет';
                }
                
                // Ориентация
                document.getElementById('preview-orientation').textContent = `Ориентация: ${orientation === 'horizontal' ? 'Горизонтальная' : 'Вертикальная'}`;
            }
            
            function getSizeByCurrent(current) {
                const currentVal = parseInt(current);
                if (currentVal <= 100) return '100';
                if (currentVal <= 160) return '160';
                if (currentVal <= 250) return '250';
                if (currentVal <= 400) return '400';
                return '630';
            }
            
            function handleSaveBreaker() {
                const tripUnit = breakerTripUnit.value;
                const auxContact = breakerAuxContact.value;
                const current = breakerCurrent.value;
                const mounting = breakerMounting.value;
                const motorDrive = breakerMotorDrive.value === 'true';
                const orientation = breakerOrientation.value;
                const quantity = parseInt(breakerQuantity.value);
                
                // Создаем конфигурацию автомата
                const breakerConfig = {
                    tripUnit: tripUnit,
                    auxContact: auxContact,
                    current: current,
                    mounting: mounting,
                    motorDrive: motorDrive,
                    orientation: orientation,
                    type: currentBreakerType
                };
                
                // Если редактируем существующий автомат
                if (currentBreakerItem) {
                    updateBreakerItem(currentBreakerItem, breakerConfig);
                    breakerModal.style.display = 'none';
                } 
                // Иначе добавляем новые автоматы
                else {
                    // Проверка на превышение модулей
                    const requiredModules = calculateRequiredModules(breakerConfig, quantity);
                    const groupId = currentBreakerColumn.dataset.outgoingGroup;
                    
                    // Проверка свободного места в текущей колонне
                    let currentModules = calculateUsedModules(currentBreakerColumn);
                    const freeModules = 32 - currentModules;
                    
                    if (requiredModules > freeModules) {
                        // Сохраняем данные для использования после подтверждения
                        currentModalData = {
                            groupId: groupId,
                            breakerConfig: breakerConfig,
                            breakerCount: quantity
                        };
                        
                        // Закрываем окно конфигурации автомата
                        breakerModal.style.display = 'none';
                        
                        // Показываем модальное окно для подтверждения
                        modalMessage.textContent = `Превышено максимальное количество модулей (32)! Доступно: ${freeModules} модулей. Добавить новую колонну?`;
                        confirmationModal.style.display = 'flex';
                    } else {
                        // Добавляем автоматы в текущую колонну
                        for (let i = 0; i < quantity; i++) {
                            addBreakerToColumn(currentBreakerColumn, breakerConfig);
                        }
                        breakerModal.style.display = 'none';
                        updateVisualization();
                        updateExcelPreview();
                    }
                }
            }
            
            function calculateRequiredModules(config, count) {
                let requiredModules = 0;
                
                // Для вертикальных автоматов требуется сборка
                if (config.orientation === 'vertical') {
                    // Каждая сборка занимает 8 модулей и вмещает до 4 автоматов
                    const assembliesNeeded = Math.ceil(count / 4);
                    requiredModules = assembliesNeeded * 8;
                } else {
                    // Для горизонтальных автоматов
                    const moduleSize = (config.type === '100A-250A') ? 3 : 4;
                    requiredModules = moduleSize * count;
                }
                
                return requiredModules;
            }
            
            function calculateUsedModules(column) {
                let usedModules = 0;
                const breakerItems = column.querySelectorAll('.breaker-item');
                
                // Собираем вертикальные автоматы по сборкам
                const verticalAssemblies = {};
                breakerItems.forEach(item => {
                    if (item.dataset.orientation === 'vertical') {
                        const assemblyId = item.dataset.assemblyId;
                        if (!verticalAssemblies[assemblyId]) {
                            verticalAssemblies[assemblyId] = [];
                        }
                        verticalAssemblies[assemblyId].push(item);
                    }
                });
                
                // Считаем модули для вертикальных сборок
                Object.values(verticalAssemblies).forEach(assembly => {
                    // Каждая сборка занимает 8 модулей
                    usedModules += 8;
                });
                
                // Считаем модули для горизонтальных автоматов
                breakerItems.forEach(item => {
                    if (item.dataset.orientation === 'horizontal') {
                        const type = item.dataset.type;
                        usedModules += (type === '100A-250A') ? 3 : 4;
                    }
                });
                
                return usedModules;
            }
            
            function addBreakerToColumn(column, config) {
                const breakerItem = document.createElement('div');
                breakerItem.className = 'breaker-item';
                breakerItem.dataset.type = config.type;
                breakerItem.dataset.tripUnit = config.tripUnit;
                breakerItem.dataset.auxContact = config.auxContact;
                breakerItem.dataset.current = config.current;
                breakerItem.dataset.mounting = config.mounting;
                breakerItem.dataset.motorDrive = config.motorDrive;
                breakerItem.dataset.orientation = config.orientation;
                
                // Для вертикальных автоматов генерируем ID сборки
                if (config.orientation === 'vertical') {
                    // Поиск существующей сборки с менее чем 4 автоматами
                    let assemblyFound = false;
                    const existingAssemblies = {};
                    
                    column.querySelectorAll('.breaker-item[data-orientation="vertical"]').forEach(item => {
                        const assemblyId = item.dataset.assemblyId;
                        if (!existingAssemblies[assemblyId]) {
                            existingAssemblies[assemblyId] = [];
                        }
                        existingAssemblies[assemblyId].push(item);
                    });
                    
                    // Поиск сборки с местом
                    for (const [assemblyId, breakers] of Object.entries(existingAssemblies)) {
                        if (breakers.length < 4) {
                            breakerItem.dataset.assemblyId = assemblyId;
                            assemblyFound = true;
                            break;
                        }
                    }
                    
                    // Если не нашли свободной сборки, создаем новую
                    if (!assemblyFound) {
                        breakerItem.dataset.assemblyId = 'assembly-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
                    }
                }
                
                // Отображаем краткую информацию
                breakerItem.innerHTML = `
                    <span>${config.current}А</span>
                    <div class="breaker-info">${config.orientation === 'vertical' ? 'Вертикальный' : 'Горизонтальный'}</div>
                    <button class="delete-breaker-btn">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                // Обработчик удаления автомата
                breakerItem.querySelector('.delete-breaker-btn').addEventListener('click', function(e) {
                    e.stopPropagation();
                    breakerItem.remove();
                    updateVisualization();
                    updateExcelPreview();
                });
                
                // Обработчик для редактирования
                breakerItem.addEventListener('click', function() {
                    const config = {
                        tripUnit: this.dataset.tripUnit,
                        auxContact: this.dataset.auxContact,
                        current: this.dataset.current,
                        mounting: this.dataset.mounting,
                        motorDrive: this.dataset.motorDrive,
                        orientation: this.dataset.orientation,
                        type: this.dataset.type
                    };
                    
                    currentBreakerItem = this;
                    currentBreakerType = this.dataset.type;
                    
                    showBreakerModal(1, currentBreakerType, config);
                });
                
                column.querySelector('.breaker-container').appendChild(breakerItem);
                updateVisualization();
                updateExcelPreview();
            }
            
            function updateBreakerItem(item, config) {
                item.dataset.tripUnit = config.tripUnit;
                item.dataset.auxContact = config.auxContact;
                item.dataset.current = config.current;
                item.dataset.mounting = config.mounting;
                item.dataset.motorDrive = config.motorDrive;
                item.dataset.orientation = config.orientation;
                item.dataset.type = config.type;
                
                // Обновляем отображаемую информацию
                item.querySelector('span').textContent = `${config.current}А`;
                item.querySelector('.breaker-info').textContent = config.orientation === 'vertical' ? 'Вертикальный' : 'Горизонтальный';
                
                currentBreakerItem = null;
                updateVisualization();
                updateExcelPreview();
            }
            
            function addBreakersWithDistribution(groupId, breakerConfig, totalBreakers) {
                // Собираем все колонны группы
                let groupColumns = [...document.querySelectorAll(`.column-item[data-outgoing-group="${groupId}"]`)];
                
                // Расчет требуемых модулей
                const requiredModules = calculateRequiredModules(breakerConfig, totalBreakers);
                
                // Расчет необходимых колонн
                const neededColumns = Math.ceil(requiredModules / 32);
                const columnsToAdd = neededColumns - groupColumns.length;
                
                // Добавляем новые колонны
                for (let i = 0; i < columnsToAdd; i++) {
                    const newColumn = addOutgoingColumn(groupId);
                    columnsContainer.appendChild(newColumn);
                    groupColumns = [...document.querySelectorAll(`.column-item[data-outgoing-group="${groupId}"]`)];
                }
                
                // Распределение автоматов
                let remainingBreakers = totalBreakers;
                
                for (const column of groupColumns) {
                    if (remainingBreakers <= 0) break;
                    
                    // Проверяем свободное место в колонне
                    let usedModules = calculateUsedModules(column);
                    const freeModules = 32 - usedModules;
                    
                    // Сколько автоматов можно добавить в эту колонну
                    let toAdd = 0;
                    
                    // Для вертикальных автоматов
                    if (breakerConfig.orientation === 'vertical') {
                        // Максимум 4 автомата на сборку
                        const maxAssemblies = Math.floor(freeModules / 8);
                        const maxBreakers = maxAssemblies * 4;
                        toAdd = Math.min(remainingBreakers, maxBreakers);
                    } else {
                        // Для горизонтальных автоматов
                        const moduleSize = (breakerConfig.type === '100A-250A') ? 3 : 4;
                        const maxBreakers = Math.floor(freeModules / moduleSize);
                        toAdd = Math.min(remainingBreakers, maxBreakers);
                    }
                    
                    if (toAdd > 0) {
                        for (let i = 0; i < toAdd; i++) {
                            addBreakerToColumn(column, breakerConfig);
                        }
                        remainingBreakers -= toAdd;
                    }
                }
                
                // Если остались нераспределенные автоматы
                if (remainingBreakers > 0) {
                    // Добавляем еще одну колонну
                    const newColumn = addOutgoingColumn(groupId);
                    columnsContainer.appendChild(newColumn);
                    
                    // Добавляем оставшиеся автоматы в новую колонну
                    for (let i = 0; i < remainingBreakers; i++) {
                        addBreakerToColumn(newColumn.querySelector('.column-item'), breakerConfig);
                    }
                }
                
                updateVisualization();
                updateExcelPreview();
            }
            
            function addOutgoingColumn(groupId) {
                const columnClone = document.importNode(columnTemplate.content, true);
                const columnNumber = columnCounter++;
                columnClone.querySelector('.column-number').textContent = columnNumber;
                
                // Устанавливаем тип колонны
                const columnItem = columnClone.querySelector('.column-item');
                columnItem.querySelector('.column-type').value = 'outgoing';
                columnItem.querySelector('.incomer-config').style.display = 'none';
                columnItem.querySelector('.sectional-config').style.display = 'none';
                columnItem.querySelector('.outgoing-config').style.display = 'block';
                columnItem.querySelector('.expansion-config').style.display = 'none';
                columnItem.dataset.outgoingGroup = groupId;
                
                // Обработчики событий
                const deleteBtn = columnItem.querySelector('.delete-column-btn');
                const addBreakerBtn = columnItem.querySelector('.add-breaker-btn');
                
                deleteBtn.addEventListener('click', deleteColumn);
                addBreakerBtn.addEventListener('click', handleAddBreaker);
                
                return columnClone;
            }
            
            function renumberColumns() {
                const columnItems = document.querySelectorAll('#columns-container .column-item');
                columnItems.forEach((item, index) => {
                    const columnNumberSpan = item.querySelector('.column-number');
                    if (columnNumberSpan) {
                        columnNumberSpan.textContent = index + 1;
                    }
                });
            }
            
            function updateVisualization() {
                cabinetVisualization.innerHTML = '';
                const columns = document.querySelectorAll('.column-item');
                let totalWidthMM = 0;
                let maxCurrent = 0;
                let breakerCount = 0;
                let totalModules = 0;
                const layout = document.querySelector('.layout-option.active input').id;
                
                columns.forEach((column, index) => {
                    const columnType = column.querySelector('.column-type').value;
                    
                    if (columnType === 'incomer' || columnType === 'sectional') {
                        const isIncomer = columnType === 'incomer';
                        
                        // Находим активный блок конфигурации
                        const configBlock = isIncomer 
                            ? column.querySelector('.incomer-config') 
                            : column.querySelector('.sectional-config');
                            
                        // Получаем значения из активного блока
                        const breakerSizeSelect = configBlock.querySelector('.breaker-size');
                        const breakerSizeValue = breakerSizeSelect ? breakerSizeSelect.value : "800";
                        const incomerCount = isIncomer 
                            ? parseInt(column.querySelector('.incomer-count').value) 
                            : 1;
                            
                        const expansionLeft = column.querySelector('.expansion-left').value;
                        const expansionRight = column.querySelector('.expansion-right').value;
                        const hasAVR = !isIncomer && column.querySelector('.avr-checkbox')?.checked;
                        
                        // Расчет ширины
                        if (expansionLeft !== 'none') totalWidthMM += parseInt(expansionLeft);
                        totalWidthMM += 700; // Основная колонна
                        if (expansionRight !== 'none') totalWidthMM += parseInt(expansionRight);
                        
                        // Расчет модулей
                        totalModules += incomerCount * 12; // 12 модулей на автомат
                        if (hasAVR) totalModules += 9; // 9 модулей для АВР
                        
                        // Определение максимального тока
                        const breakerCurrent = parseInt(breakerSizeValue);
                        if (breakerCurrent > maxCurrent) {
                            maxCurrent = breakerCurrent;
                        }
                        
                        // Визуализация
                        // Левый блок расширения
                        if (expansionLeft !== 'none') {
                            const widthPx = parseInt(expansionLeft) / 700 * 200;
                            const expansionColumn = document.createElement('div');
                            expansionColumn.className = 'cabinet-column';
                            expansionColumn.style.width = widthPx + 'px';
                            expansionColumn.style.background = 'rgba(255, 193, 7, 0.3)';
                            expansionColumn.innerHTML = `<div class="column-title">${expansionLeft} мм</div>`;
                            cabinetVisualization.appendChild(expansionColumn);
                        }
                        
                        // Основная колонна
                        const columnEl = createColumnElement(200, columnType);
                        const section = document.createElement('div');
                        section.className = 'section';
                        
                        // Для секционной колонны: сначала АВР, затем автомат
                        if (columnType === 'sectional' && hasAVR) {
                            const avrEl = document.createElement('div');
                            avrEl.className = 'avr';
                            avrEl.textContent = 'АВР на SystemePLC';
                            section.appendChild(avrEl);
                        }
                        
                        // Автоматы
                        for (let i = 0; i < incomerCount; i++) {
                            const breakerEl = document.createElement('div');
                            breakerEl.className = isIncomer ? 'incomer' : 'sectional';
                            breakerEl.textContent = `${isIncomer ? 'Ввод' : 'Секционный'} (ACB, ${breakerSizeValue}А)`;
                            section.appendChild(breakerEl);
                        }
                        
                        // Для вводной колонны: АВР после автоматов
                        if (columnType === 'incomer' && hasAVR) {
                            const avrEl = document.createElement('div');
                            avrEl.className = 'avr';
                            avrEl.textContent = 'АВР на SystemePLC';
                            section.appendChild(avrEl);
                        }
                        
                        columnEl.appendChild(section);
                        cabinetVisualization.appendChild(columnEl);
                        
                        // Правый блок расширения
                        if (expansionRight !== 'none') {
                            const widthPx = parseInt(expansionRight) / 700 * 200;
                            const expansionColumn = document.createElement('div');
                            expansionColumn.className = 'cabinet-column';
                            expansionColumn.style.width = widthPx + 'px';
                            expansionColumn.style.background = 'rgba(255, 193, 7, 0.3)';
                            expansionColumn.innerHTML = `<div class="column-title">${expansionRight} мм</div>`;
                            cabinetVisualization.appendChild(expansionColumn);
                        }
                        
                        // Индикатор модулей
                        const moduleIndicator = document.createElement('div');
                        moduleIndicator.className = 'module-indicator';
                        moduleIndicator.textContent = `Модули: ${incomerCount * 12 + (hasAVR ? 9 : 0)}/32`;
                        section.appendChild(moduleIndicator);
                    } 
                    else if (columnType === 'outgoing') {
                        // Шинный отсек (слева) - 200 мм
                        totalWidthMM += 200;
                        const busColumn = document.createElement('div');
                        busColumn.className = 'cabinet-column';
                        busColumn.style.width = '57px';
                        busColumn.style.background = 'rgba(0, 150, 136, 0.3)';
                        busColumn.innerHTML = `<div class="bus-compartment"></div>`;
                        cabinetVisualization.appendChild(busColumn);
                        
                        // Основная колонна (отходящая) - 700 мм
                        totalWidthMM += 700;
                        const columnEl = createColumnElement(200, columnType);
                        
                        // Секция с автоматами
                        const section = createBreakerSection(column);
                        columnEl.appendChild(section);
                        cabinetVisualization.appendChild(columnEl);
                        
                        // Кабельный отсек (справа) - 400 мм (только у стены)
                        if (layout === 'wall-layout') {
                            totalWidthMM += 400;
                            const cableColumn = document.createElement('div');
                            cableColumn.className = 'cabinet-column';
                            cableColumn.style.width = '114px';
                            cableColumn.style.background = 'rgba(156, 39, 176, 0.1)';
                            cableColumn.innerHTML = `<div class="cable-compartment"></div>`;
                            cabinetVisualization.appendChild(cableColumn);
                        }
                        
                        // Подсчет автоматов и модулей
                        const breakerItems = column.querySelectorAll('.breaker-item');
                        breakerCount += breakerItems.length;
                        
                        // Расчет модулей
                        totalModules += calculateUsedModules(column);
                    }
                });
                
                // Обновляем технические характеристики
                document.getElementById('total-width').textContent = totalWidthMM + ' мм';
                document.getElementById('total-current').textContent = maxCurrent + ' А';
                document.getElementById('column-count').textContent = columns.length;
                document.getElementById('breaker-count').textContent = breakerCount;
                document.getElementById('used-modules').textContent = `${totalModules}/32`;
            }
            
            function createColumnElement(widthPx, type) {
                const columnEl = document.createElement('div');
                columnEl.className = 'cabinet-column';
                columnEl.style.width = widthPx + 'px';
                
                // Заголовок колонны с типом
                const columnTitle = document.createElement('div');
                columnTitle.className = 'column-title';
                
                if (type === 'incomer') {
                    columnTitle.textContent = 'Вводная';
                    columnEl.style.background = 'rgba(33, 150, 243, 0.3)';
                } 
                else if (type === 'sectional') {
                    columnTitle.textContent = 'Секционная';
                    columnEl.style.background = 'rgba(255, 152, 0, 0.3)';
                }
                else if (type === 'outgoing') {
                    columnTitle.textContent = 'Отходящая';
                    columnEl.style.background = 'rgba(76, 175, 80, 0.3)';
                }
                
                columnEl.appendChild(columnTitle);
                
                return columnEl;
            }
            
            function createBreakerSection(column) {
                const section = document.createElement('div');
                section.className = 'section';
                
                const breakerItems = column.querySelectorAll('.breaker-item');
                let moduleCount = calculateUsedModules(column);
                
                // Индикатор модулей
                const moduleIndicator = document.createElement('div');
                moduleIndicator.className = 'module-indicator';
                moduleIndicator.textContent = `Модули: ${moduleCount}/32`;
                section.appendChild(moduleIndicator);
                
                // Группируем автоматы по ориентации и сборкам
                const horizontalBreakers = [];
                const verticalAssemblies = {};
                
                breakerItems.forEach(item => {
                    if (item.dataset.orientation === 'vertical') {
                        const assemblyId = item.dataset.assemblyId;
                        if (!verticalAssemblies[assemblyId]) {
                            verticalAssemblies[assemblyId] = [];
                        }
                        verticalAssemblies[assemblyId].push(item);
                    } else {
                        horizontalBreakers.push(item);
                    }
                });
                
                // Обрабатываем горизонтальные автоматы
                horizontalBreakers.forEach(item => {
                    const type = item.dataset.type;
                    const height = (type === '100A-250A') ? '37.5px' : '50px';
                    const current = item.dataset.current;
                    
                    const breakerEl = document.createElement('div');
                    breakerEl.className = 'breaker breaker-horizontal';
                    breakerEl.style.height = height;
                    breakerEl.textContent = `${current}А`;
                    section.appendChild(breakerEl);
                });
                
                // Обрабатываем вертикальные сборки
                Object.values(verticalAssemblies).forEach(assembly => {
                    const assemblyEl = document.createElement('div');
                    assemblyEl.className = 'vertical-assembly';
                    
                    const assemblyTitle = document.createElement('div');
                    assemblyTitle.className = 'vertical-assembly-title';
                    assemblyTitle.textContent = 'Вертикальная сборка';
                    assemblyEl.appendChild(assemblyTitle);
                    
                    const assemblyContent = document.createElement('div');
                    assemblyContent.className = 'vertical-assembly-content';
                    
                    assembly.forEach(item => {
                        const current = item.dataset.current;
                        
                        const breakerEl = document.createElement('div');
                        breakerEl.className = 'vertical-breaker';
                        breakerEl.textContent = `${current}А`;
                        assemblyContent.appendChild(breakerEl);
                    });
                    
                    assemblyEl.appendChild(assemblyContent);
                    
                    // Добавляем свободное пространство под сборкой
                    const spaceEl = document.createElement('div');
                    spaceEl.className = 'vertical-assembly-space';
                    assemblyEl.appendChild(spaceEl);
                    
                    // Информация о модулях сборки
                    const moduleInfo = document.createElement('div');
                    moduleInfo.className = 'assembly-module-info';
                    moduleInfo.textContent = '8 модулей';
                    assemblyEl.appendChild(moduleInfo);
                    
                    section.appendChild(assemblyEl);
                });
                
                return section;
            }
            
            function updateExcelPreview() {
                excelPreviewTable.innerHTML = '';
                
                const columns = document.querySelectorAll('.column-item');
                let rowCounter = 1;
                
                columns.forEach((column, columnIndex) => {
                    const columnType = column.querySelector('.column-type').value;
                    
                    // Добавляем заголовок колонны
                    const columnRow = document.createElement('tr');
                    columnRow.style.backgroundColor = 'rgba(33, 150, 243, 0.2)';
                    columnRow.innerHTML = `
                        <td colspan="5"><strong>Колонна ${columnIndex + 1}: ${getColumnTypeName(columnType)}</strong></td>
                    `;
                    excelPreviewTable.appendChild(columnRow);
                    
                    if (columnType === 'incomer' || columnType === 'sectional') {
                        const isIncomer = columnType === 'incomer';
                        
                        // Находим активный блок конфигурации
                        const configBlock = isIncomer 
                            ? column.querySelector('.incomer-config') 
                            : column.querySelector('.sectional-config');
                            
                        // Получаем значения из активного блока
                        const breakerSizeSelect = configBlock.querySelector('.breaker-size');
                        const breakerSizeValue = breakerSizeSelect ? breakerSizeSelect.value : "800";
                        const incomerCount = isIncomer 
                            ? parseInt(column.querySelector('.incomer-count').value) 
                            : 1;
                            
                        const expansionLeft = column.querySelector('.expansion-left').value;
                        const expansionRight = column.querySelector('.expansion-right').value;
                        const hasAVR = !isIncomer && column.querySelector('.avr-checkbox')?.checked;
                        
                        // Добавляем строку для основного оборудования
                        const mainRow = document.createElement('tr');
                        mainRow.innerHTML = `
                            <td>${rowCounter++}</td>
                            <td>COL-${isIncomer ? 'IN' : 'SEC'}-${breakerSizeValue}</td>
                            <td>${isIncomer ? 'Вводная колонна' : 'Секционная колонна'} ${breakerSizeValue}А</td>
                            <td>1</td>
                            <td>${expansionLeft !== 'none' ? 'Блок слева: ' + expansionLeft + 'мм' : ''} ${expansionRight !== 'none' ? 'Блок справа: ' + expansionRight + 'мм' : ''}</td>
                        `;
                        excelPreviewTable.appendChild(mainRow);
                        
                        // Добавляем строки для автоматов
                        for (let i = 0; i < incomerCount; i++) {
                            const breakerRow = document.createElement('tr');
                            breakerRow.innerHTML = `
                                <td>${rowCounter++}</td>
                                <td>ACB-${breakerSizeValue}</td>
                                <td>${isIncomer ? 'Вводной' : 'Секционный'} автомат ${breakerSizeValue}А</td>
                                <td>1</td>
                                <td></td>
                            `;
                            excelPreviewTable.appendChild(breakerRow);
                        }
                        
                        // Добавляем строку для АВР
                        if (hasAVR) {
                            const avrRow = document.createElement('tr');
                            avrRow.innerHTML = `
                                <td>${rowCounter++}</td>
                                <td>AVR-PLC</td>
                                <td>Автоматический ввод резерва</td>
                                <td>1</td>
                                <td>На SystemePLC</td>
                            `;
                            excelPreviewTable.appendChild(avrRow);
                        }
                    } 
                    else if (columnType === 'outgoing') {
                        const breakerItems = column.querySelectorAll('.breaker-item');
                        
                        // Добавляем строку для колонны
                        const mainRow = document.createElement('tr');
                        mainRow.innerHTML = `
                            <td>${rowCounter++}</td>
                            <td>COL-OUT</td>
                            <td>Отходящая колонна</td>
                            <td>1</td>
                            <td></td>
                        `;
                        excelPreviewTable.appendChild(mainRow);
                        
                        // Добавляем строки для каждого автомата и его аксессуаров
                        breakerItems.forEach((item, idx) => {
                            const type = item.dataset.type;
                            const tripUnit = item.dataset.tripUnit;
                            const auxContact = item.dataset.auxContact;
                            const current = item.dataset.current;
                            const mounting = item.dataset.mounting;
                            const motorDrive = item.dataset.motorDrive === 'true';
                            const orientation = item.dataset.orientation;
                            
                            // Определение артикула основного автомата
                            let breakerRef = '';
                            let breakerDesc = '';
                            
                            if (tripUnit === 'TM-D') {
                                breakerRef = `SPC${getSizeByCurrent(current)}F${current.toString().padStart(3, '0')}L3DF`;
                                breakerDesc = `Автомат SPC${getSizeByCurrent(current)} TM-D ${current}А`;
                            } else if (tripUnit === 'SystemeLogic2') {
                                breakerRef = `SPC${getSizeByCurrent(current)}F${current.toString().padStart(3, '0')}22L3DF`;
                                breakerDesc = `Автомат SPC${getSizeByCurrent(current)} SystemeLogic 2 ${current}А`;
                            } else if (tripUnit === 'SystemeLogic5') {
                                breakerRef = `SPC${getSizeByCurrent(current)}F${current.toString().padStart(3, '0')}52E3DFC`;
                                breakerDesc = `Автомат SPC${getSizeByCurrent(current)} SystemeLogic 5 ${current}А`;
                            }
                            
                            // Добавляем строку для основного автомата
                            const breakerRow = document.createElement('tr');
                            breakerRow.innerHTML = `
                                <td>${rowCounter++}</td>
                                <td>${breakerRef}</td>
                                <td>${breakerDesc}</td>
                                <td>1</td>
                                <td>${orientation === 'vertical' ? 'Вертикальная установка' : 'Горизонтальная установка'}</td>
                            `;
                            excelPreviewTable.appendChild(breakerRow);
                            
                            // Дополнительный контакт
                            if (auxContact !== '0') {
                                const auxRow = document.createElement('tr');
                                auxRow.innerHTML = `
                                    <td>${rowCounter++}</td>
                                    <td>SPC-OFSD-01-06</td>
                                    <td>Дополнительный контакт</td>
                                    <td>${auxContact}</td>
                                    <td></td>
                                `;
                                excelPreviewTable.appendChild(auxRow);
                            }
                            
                            // Способ установки
                            if (mounting !== 'fixed') {
                                let mountingRef = '';
                                let mountingDesc = '';
                                
                                if (mounting === 'plug-in') {
                                    mountingRef = parseInt(current) <= 250 ? 'SPC-PIK3-01-02' : 'SPC-PIK3-04-06';
                                    mountingDesc = 'Комплект для втычной установки';
                                } else if (mounting === 'withdrawable') {
                                    mountingRef = parseInt(current) <= 250 ? 'SPC-DOK3-01-02' : 'SPC-DOK3-04-06';
                                    mountingDesc = 'Комплект для выкатной установки';
                                }
                                
                                const mountingRow = document.createElement('tr');
                                mountingRow.innerHTML = `
                                    <td>${rowCounter++}</td>
                                    <td>${mountingRef}</td>
                                    <td>${mountingDesc}</td>
                                    <td>1</td>
                                    <td></td>
                                `;
                                excelPreviewTable.appendChild(mountingRow);
                            }
                            
                            // Мотор привод
                            if (motorDrive) {
                                const motorRef = parseInt(current) <= 250 ? 'SPC-MA2-01-02' : 'SPC-MA2-04-06';
                                const motorRow = document.createElement('tr');
                                motorRow.innerHTML = `
                                    <td>${rowCounter++}</td>
                                    <td>${motorRef}</td>
                                    <td>Мотор привод</td>
                                    <td>1</td>
                                    <td></td>
                                `;
                                excelPreviewTable.appendChild(motorRow);
                            }
                        });
                    }
                });
            }
            
            function getColumnTypeName(type) {
                switch(type) {
                    case 'incomer': return 'Вводная';
                    case 'sectional': return 'Секционная';
                    case 'outgoing': return 'Отходящая';
                    default: return '';
                }
            }
            
            function exportToExcel() {
                // Создаем книгу
                const wb = XLSX.utils.book_new();
                
                // Собираем данные
                const data = [
                    ['Позиция', 'Артикул', 'Наименование', 'Кол-во', 'Примечание']
                ];
                
                const columns = document.querySelectorAll('.column-item');
                let rowCounter = 1;
                
                columns.forEach((column, columnIndex) => {
                    const columnType = column.querySelector('.column-type').value;
                    
                    // Добавляем заголовок колонны
                    data.push([
                        rowCounter++,
                        '',
        `Колонна ${columnIndex + 1}: ${getColumnTypeName(columnType)}`,
                        '',
                        ''
                    ]);
                    
                    if (columnType === 'incomer' || columnType === 'sectional') {
                        const isIncomer = columnType === 'incomer';
                        
                        // Находим активный блок конфигурации
                        const configBlock = isIncomer 
                            ? column.querySelector('.incomer-config') 
                            : column.querySelector('.sectional-config');
                            
                        // Получаем значения из активного блока
                        const breakerSizeSelect = configBlock.querySelector('.breaker-size');
                        const breakerSizeValue = breakerSizeSelect ? breakerSizeSelect.value : "800";
                        const incomerCount = isIncomer 
                            ? parseInt(column.querySelector('.incomer-count').value) 
                            : 1;
                            
                        const expansionLeft = column.querySelector('.expansion-left').value;
                        const expansionRight = column.querySelector('.expansion-right').value;
                        const hasAVR = !isIncomer && column.querySelector('.avr-checkbox')?.checked;
                        
                        // Добавляем строку для основного оборудования
                        data.push([
                            rowCounter++,
                            `COL-${isIncomer ? 'IN' : 'SEC'}-${breakerSizeValue}`,
                            `${isIncomer ? 'Вводная колонна' : 'Секционная колонна'} ${breakerSizeValue}А`,
                            '1',
                            (expansionLeft !== 'none' ? 'Блок слева: ' + expansionLeft + 'мм' : '') + 
                            (expansionRight !== 'none' ? ' Блок справа: ' + expansionRight + 'мм' : '')
                        ]);
                        
                        // Добавляем строки для автоматов
                        for (let i = 0; i < incomerCount; i++) {
                            data.push([
                                rowCounter++,
                                `ACB-${breakerSizeValue}`,
                                `${isIncomer ? 'Вводной' : 'Секционный'} автомат ${breakerSizeValue}А`,
                                '1',
                                ''
                            ]);
                        }
                        
                        // Добавляем строку для АВР
                        if (hasAVR) {
                            data.push([
                                rowCounter++,
                                'AVR-PLC',
                                'Автоматический ввод резерва',
                                '1',
                                'На SystemePLC'
                            ]);
                        }
                    } 
                    else if (columnType === 'outgoing') {
                        const breakerItems = column.querySelectorAll('.breaker-item');
                        
                        // Добавляем строку для колонны
                        data.push([
                            rowCounter++,
                            'COL-OUT',
                            'Отходящая колонна',
                            '1',
                            ''
                        ]);
                        
                        // Добавляем строки для каждого автомата и его аксессуаров
                        breakerItems.forEach(item => {
                            const type = item.dataset.type;
                            const tripUnit = item.dataset.tripUnit;
                            const auxContact = item.dataset.auxContact;
                            const current = item.dataset.current;
                            const mounting = item.dataset.mounting;
                            const motorDrive = item.dataset.motorDrive === 'true';
                            const orientation = item.dataset.orientation;
                            
                            // Определение артикула основного автомата
                            let breakerRef = '';
                            let breakerDesc = '';
                            
                            if (tripUnit === 'TM-D') {
                                breakerRef = `SPC${getSizeByCurrent(current)}F${current.toString().padStart(3, '0')}L3DF`;
                                breakerDesc = `Автомат SPC${getSizeByCurrent(current)} TM-D ${current}А`;
                            } else if (tripUnit === 'SystemeLogic2') {
                                breakerRef = `SPC${getSizeByCurrent(current)}F${current.toString().padStart(3, '0')}22L3DF`;
                                breakerDesc = `Автомат SPC${getSizeByCurrent(current)} SystemeLogic 2 ${current}А`;
                            } else if (tripUnit === 'SystemeLogic5') {
                                breakerRef = `SPC${getSizeByCurrent(current)}F${current.toString().padStart(3, '0')}52E3DFC`;
                                breakerDesc = `Автомат SPC${getSizeByCurrent(current)} SystemeLogic 5 ${current}А`;
                            }
                            
                            // Добавляем строку для основного автомата
                            data.push([
                                rowCounter++,
                                breakerRef,
                                breakerDesc,
                                '1',
                                orientation === 'vertical' ? 'Вертикальная установка' : 'Горизонтальная установка'
                            ]);
                            
                            // Дополнительный контакт
                            if (auxContact !== '0') {
                                data.push([
                                    rowCounter++,
                                    'SPC-OFSD-01-06',
                                    'Дополнительный контакт',
                                    auxContact,
                                    ''
                                ]);
                            }
                            
                            // Способ установки
                            if (mounting !== 'fixed') {
                                let mountingRef = '';
                                let mountingDesc = '';
                                
                                if (mounting === 'plug-in') {
                                    mountingRef = parseInt(current) <= 250 ? 'SPC-PIK3-01-02' : 'SPC-PIK3-04-06';
                                    mountingDesc = 'Комплект для втычной установки';
                                } else if (mounting === 'withdrawable') {
                                    mountingRef = parseInt(current) <= 250 ? 'SPC-DOK3-01-02' : 'SPC-DOK3-04-06';
                                    mountingDesc = 'Комплект для выкатной установки';
                                }
                                
                                data.push([
                                    rowCounter++,
                                    mountingRef,
                                    mountingDesc,
                                    '1',
                                    ''
                                ]);
                            }
                            
                            // Мотор привод
                            if (motorDrive) {
                                const motorRef = parseInt(current) <= 250 ? 'SPC-MA2-01-02' : 'SPC-MA2-04-06';
                                data.push([
                                    rowCounter++,
                                    motorRef,
                                    'Мотор привод',
                                    '1',
                                    ''
                                ]);
                            }
                        });
                    }
                });
                
                // Создаем лист
                const ws = XLSX.utils.aoa_to_sheet(data);
                
                // Добавляем лист в книгу
                XLSX.utils.book_append_sheet(wb, ws, "Конфигурация ГРЩ");
                
                // Сохраняем файл
                XLSX.writeFile(wb, "ГРЩ_SystemeBlock.xlsx");
            }
            
            // Инициализация предпросмотра
            updateExcelPreview();
        });
    </script>
</body>
</html>
